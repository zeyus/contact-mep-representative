<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="style.css" rel="stylesheet">
</head>

<body>
    <div class="container">
        <h1>Members of the European Parliament contact list</h1>
    </div>
    <div class="container">
        <ul id="country-list" class="row list-unstyled">

        </ul>
    </div>

    <template id="country-template">
        <li class="country col-md-4">
            <div class="country-name">
                <a class="country-link"></a>
            </div>
            <div class="member-list list-unstyled d-none ">
                <h2 class="country-detail-name"></h2>
                <div
                    class="container row row-cols-1 row-cols-sm-1 row-cols-md-1 row-cols-lg-2 row-cols-xl-2 row-cols-xxl-3 member-cards card-columns">

                </div>
            </div>
        </li>
    </template>
    <template id="member-template">
        <div class="member card col m-1 p-0 mb-4">
            <div class="card-header">
                <h5 class="text-center member-name"></h5>
            </div>
            <div class="card-body">
                <div class="member-party mb-3 row">
                    <div class="fw-bold col-4">Party</div>
                </div>


                <div class="member-local-party row">
                    <div class="fw-bold col-4">Local party</div>
                </div>
            </div>
            <div class="card-footer mt-4">
                <h5 class="text-center">Contact details</h5>
                <ul class="member-contacts list-unstyled">

                </ul>
            </div>
        </div>
    </template>
    <template id="contact-template">
        <li class="member-contact mt-3">
            <!-- <div><span class="contact-type fw-bold"></span></div> -->
            <div class=""><span class="contact-icon"></span>&nbsp;<span class="contact-detail"></span></div>
        </li>
    </template>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script lang="javascript">
        var members_by_country;
        var xmlhttp = new XMLHttpRequest();


        selectedCountry = window.location.hash.substr(1);
        console.log(selectedCountry);

        xmlhttp.onreadystatechange = function () {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                members_by_country = JSON.parse(xmlhttp.responseText);
                displayCountryList();
            }
        }
        xmlhttp.open("GET", "data/members_by_country.json", true);
        xmlhttp.send();

        function wrangleURI(url) {
            // also strip query string, hash and trailing slashes
            var fixedurl = url.split(/[?#]/)[0].replace(/\/+$/, '');
            if (!fixedurl.match(/^https?:\/\//)) {
                fixedurl = 'https://' + fixedurl;
            }
            // trim trailing whitespace
            fixedurl = fixedurl.trim();
            // remove trailing slashes (again, there are some weird cases)
            fixedurl = fixedurl.replace(/\/+$/, '');
            const parsed = URL.parse(fixedurl);
            if (parsed === null) {
                return url;
            }
            return decodeURI(parsed.pathname.split("/").pop())
        }

        function displayCountryList() {
            selectedCountry = window.location.hash.substr(1);
            // var container = document.createElement('div');
            // container.id = 'countryList';

            var contactMap = {
                email: {
                    icon: 'envelope-at',
                    title: 'Email', transform: function (raw) {
                        // replace [at] with @, [dot] with . and reverse the string
                        var email = raw.replace(/\[at\]/g, '@').replace(/\[dot\]/g, '.').split("").reverse().join("");
                        return '<a href="mailto:' + email + '">' + email + '</a>';
                    }
                },
                website: {
                    icon: 'globe',
                    title: 'Website',
                    transform: function (raw) {
                        return '<a href="' + raw + '">' + raw.replace(/^https?:\/\//, '') + '</a>';
                    }
                },
                blog: { 
                    icon: 'journal',
                    title: 'Blog',
                    transform: function (raw) {
                        return '<a href="' + raw + '">' + raw.replace(/^https?:\/\//, '') + '</a>';
                    }
                },
                linkedin: { 
                    icon: 'linkedin',
                    title: 'LinkedIn',
                    transform: function (raw) {
                        const username = wrangleURI(raw);
                        return '<a href="' + raw + '">' + username + '</a>';
                    }
                },
                facebook: { 
                    icon: 'facebook',
                    title: 'Facebook',
                    transform: function (raw) {
                        const username = wrangleURI(raw);
                        return '<a href="' + raw + '">' + username + '</a>';
                    }
                },
                twitter: {
                    icon: 'twitter-x',
                    title: 'X',
                    transform: function (raw) { 
                        const username = wrangleURI(raw);
                        return '<a href="' + raw + '">' + username + '</a>';
                    }
                },
                instagram: {
                    icon: 'instagram',
                    title: 'Instagram',
                    transform: function (raw) {
                        const username = wrangleURI(raw);
                        return '<a href="' + raw + '">' + username + '</a>';
                    }
                },
                youtube: {
                    icon: 'youtube',
                    title: 'Youtube',
                    transform: function (raw) {
                        const username = wrangleURI(raw);
                        return '<a href="' + raw + '">' + username + '</a>';
                    }
                },
                birth_date: {
                    icon: 'cake2',
                    title: 'Birth date',
                    transform: function (raw) {
                        // attempt to parse the date
                        try {
                            var date = new Date(raw);
                            // calculate age in years
                            var age = Math.floor((new Date() - date) / 31536000000);
                            return date.toDateString() + ' (age ' + age + ')';
                        } catch (e) {
                            // if parsing fails, return the raw string
                            return raw;
                        }
                    }
                },
                birth_place: {
                    icon: 'geo-alt',
                    title: 'Birth place',
                    transform: function (raw) {
                        return raw;
                    }
                },
            };

            var countries = [];

            for (var country in members_by_country) {
                // skip loop if the property is from prototype
                if (!members_by_country.hasOwnProperty(country)) continue;
                countries.push(country);
                var members = members_by_country[country];
            }

            countries.sort();

            var countryList = document.getElementById('country-list');

            countries.forEach(function (country) {
                var countryTemplate = document.getElementById('country-template').content.cloneNode(true);
                countryTemplate.querySelector('.country-link').innerText = country;
                countryTemplate.querySelector('.country-link').href = "#" + country;
                countryTemplate.querySelector('.country').id = 'country-detail-' + country;
                countryTemplate.querySelector('.country-detail-name').innerText = country;

                countryTemplate.querySelector('.country-link').addEventListener('click', function (evt) {

                    var memberList = document.getElementById('member-list-' + country);
                    var countryDetail = document.getElementById('country-detail-' + country);
                    var isActive = countryDetail.classList.contains('expanded');
                    var openLists = document.getElementsByClassName('current-country');
                    for (let openList of openLists) {
                        openList.classList.add("d-none");
                        openList.classList.remove("current-country");
                    }
                    var openLists = document.getElementsByClassName('expanded');
                    for (let openList of openLists) {
                        openList.classList.remove("expanded");
                        openList.classList.remove("col-md-12");
                        openList.classList.add("col-md-4");
                    }
                    if (!isActive) {
                        memberList.classList.remove("d-none");
                        memberList.classList.add("current-country");
                        countryDetail.classList.add("expanded");
                        countryDetail.classList.add("col-md-12");
                        countryDetail.classList.remove("col-md-4");
                    }

                    return true;
                    // countryTemplate.querySelector('.member-list').classList.remove("d-none");
                    // countryTemplate.querySelector('.member-list').classList.add("current-country");
                });

                members_by_country[country].forEach(function (member) {
                    var memberTemplate = document.getElementById('member-template').content.cloneNode(true);
                    if (member.hasOwnProperty('fullName')) {
                        member.fullName.forEach(function (name) {
                            var name_container = document.createElement('span');
                            name_container.appendChild(document.createTextNode(name));
                            memberTemplate.querySelector('.member-name').appendChild(name_container);

                        });
                    }

                    if (member.hasOwnProperty('politicalGroup')) {
                        member.politicalGroup.forEach(function (name) {
                            var name_container = document.createElement('div');
                            name_container.appendChild(document.createTextNode(name));
                            name_container.classList.add('col-8');
                            memberTemplate.querySelector('.member-party').appendChild(name_container);

                        });
                    }

                    if (member.hasOwnProperty('nationalPoliticalGroup')) {
                        member.nationalPoliticalGroup.forEach(function (name) {
                            var name_container = document.createElement('div');
                            // add col-9 class
                            name_container.classList.add('col-8');
                            name_container.appendChild(document.createTextNode(name));
                            memberTemplate.querySelector('.member-local-party').appendChild(name_container);

                        });
                    }

                    if (member.hasOwnProperty('contact_data')) {
                        for (const [contactType, contactItem] of Object.entries(member.contact_data)) {
                            var contactTemplate = document.getElementById('contact-template').content.cloneNode(true);
                            if (contactMap.hasOwnProperty(contactType)) {
                                var contactIcon = contactMap[contactType].icon;
                                var contactTypeTitle = contactMap[contactType].title;
                                var contactDetail = contactMap[contactType].transform(contactItem)
                            } else {
                                var contactIcon = 'question';
                                var contactTypeTitle = contactType;
                                var contactDetail = contactItem;
                            }
                            contactTemplate.querySelector('.contact-icon').classList.add('bi-' + contactIcon);
                            // contactTemplate.querySelector('.contact-type').innerText = contactTypeTitle;
                            contactTemplate.querySelector('.contact-detail').innerHTML = contactDetail;
                            memberTemplate.querySelector('.member-contacts').appendChild(contactTemplate);
                        }

                    } else {
                        // no eContact??
                    }
                    if (member.hasOwnProperty('address')) {
                        member.address.forEach(function (contact) {
                            if (contact.hasOwnProperty('phone')) {
                                contact.phone.forEach(function (phone) {
                                    var contactTemplate = document.getElementById('contact-template').content.cloneNode(true);
                                    contactTemplate.querySelector('.contact-type').innerText = 'Phone (' + contact.town[0] + ', ' + contact.country[0] + ')';
                                    contactTemplate.querySelector('.contact-detail').innerText = phone;
                                    memberTemplate.querySelector('.member-contacts').appendChild(contactTemplate);
                                });
                            }

                        });
                    }
                    countryTemplate.querySelector('.member-list').id = 'member-list-' + country;
                    countryTemplate.querySelector('.member-cards').appendChild(memberTemplate);
                });

                if (country == selectedCountry) {
                    countryTemplate.querySelector('.member-list').classList.remove("d-none");
                    countryTemplate.querySelector('.member-list').classList.add("current-country");
                    countryTemplate.querySelector('.country').classList.add('expanded');
                    countryTemplate.querySelector('.country').classList.remove("col-md-4");
                    countryTemplate.querySelector('.country').classList.add("col-md-12");
                }

                countryList.appendChild(countryTemplate);

            });
        }

    </script>
</body>

</html>
